<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>News Portal App ðŸ“–ðŸ—ž</title>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        function loadArticles(key) {
            var r = new XMLHttpRequest();
            if(key === 1) r.open("GET", "http://localhost:8080/blogs/api/v1/public/articles");
            else r.open("GET", "http://localhost:8080/blogs/api/v1/public/articles/no-author");
            r.send();
            r.onload = function() {
                if(r.status === 200)
                {
                    var json_data = JSON.parse((r.response));
                    var table = document.createElement('table');

                    for (var i in json_data){
                        var tr = document.createElement('tr');

                        var td1 = document.createElement('td');
                        var td2 = document.createElement('td');
                        var td3 = document.createElement('td');
                        var td4 = document.createElement('td');
                        var td5 = document.createElement('td');

                        var text1 = document.createTextNode(json_data[i]['articleId']);
                        var text2 = document.createTextNode(json_data[i]['title']);
                        var text3 = document.createTextNode(json_data[i]['body']);
                        var text4 = document.createTextNode(json_data[i]['timestamp']);
                        var text5 = document.createTextNode(json_data[i]['published']);

                        td1.appendChild(text1);
                        td2.appendChild(text2);
                        td3.appendChild(text3);
                        td4.appendChild(text4);
                        td5.appendChild(text5);
                        tr.appendChild(td1);
                        tr.appendChild(td2);
                        tr.appendChild(td3);
                        tr.appendChild(td4);
                        tr.appendChild(td5);

                        table.appendChild(tr);
                    }
                    document.getElementById("results").innerHTML = "";
                    document.getElementById("results").appendChild(table);
                }
                else{
                    if(key === 1) alert("failed to load all articles");
                    else alert("failed to load all articles with no author");
                }
            }
        }

        function loadAllComments() {
            var r = new XMLHttpRequest();
            r.open("GET", "http://localhost:8080/blogs/api/v1/public/comments");
            r.send();
            r.onload = function() {
                if(r.status === 200)
                {
                    var json_data = JSON.parse((r.response));
                    var table = document.createElement('table');

                    for (var i in json_data){
                        var tr = document.createElement('tr');

                        var td1 = document.createElement('td');
                        var td2 = document.createElement('td');

                        var text1 = document.createTextNode(json_data[i]['commentId']);
                        var text2 = document.createTextNode(json_data[i]['comment']);

                        td1.appendChild(text1);
                        td2.appendChild(text2);
                        tr.appendChild(td1);
                        tr.appendChild(td2);

                        table.appendChild(tr);
                    }
                    document.getElementById("results").innerHTML = "";
                    document.getElementById("results").appendChild(table);
                }
                else{
                    alert("failed to load all articles");
                }
            }
        }

        function loadCommentsByArticleId() {
            var r = new XMLHttpRequest();
            var articleId = document.getElementById("articleId").value;
            console.log(articleId);
            r.open("GET", "http://localhost:8080/blogs/api/v1/public/article/"+ articleId + "/comments");
            r.send();
            r.onload = function() {
                if(r.status === 200)
                {
                    var json_data = JSON.parse((r.response));
                    var table = document.createElement('table');

                    for (var i in json_data){
                        var tr = document.createElement('tr');

                        var td1 = document.createElement('td');
                        var td2 = document.createElement('td');

                        var text1 = document.createTextNode(json_data[i]['commentId']);
                        var text2 = document.createTextNode(json_data[i]['comment']);

                        td1.appendChild(text1);
                        td2.appendChild(text2);
                        tr.appendChild(td1);
                        tr.appendChild(td2);

                        table.appendChild(tr);
                    }
                    document.getElementById("results").innerHTML = "";
                    document.getElementById("results").appendChild(table);
                }
                else{
                    var error = JSON.parse((r.response));
                    alert("failed to load comments with articleId="+articleId+"\nMessage: "+error['errorMessage']);
                }
            }
        }

        function doLogin() {
            var email = document.getElementById("loginEmail").value;
            var password = document.getElementById("loginPassword").value;
            var data = {
                "username": email,
                "password": password
            };

            var xhr = new XMLHttpRequest();
            xhr.open("POST", "http://localhost:8080/blogs/api/v1/public/login", true);
            xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
            xhr.send(JSON.stringify(data));

            xhr.onloadend = function () {
                if(xhr.status === 200)
                {
                    alert(xhr.response.toString())
                }
                else
                {
                    alert(xhr.status+" " + xhr.response.toString())
                }
            };
        }

        function r_getAuthors() {
            var token_;
            var userName = "user1";
            var passWord = "123Admin";
            var caspioTokenUrl = "http://localhost:8080/blogs/api/v1/r/authors";
            var request = new XMLHttpRequest();

            function getToken(url, clientID, clientSecret) {
                var key;
                request.open("GET", url, true);
                request.setRequestHeader("Content-type", "application/json");
                request.send("grant_type=client_credentials&client_id="+clientID+"&"+"client_secret="+clientSecret);
                request.onreadystatechange = function () {
                    if (request.readyState === request.DONE) {
                        var response = request.responseText;
                        var obj = JSON.parse(response);
                        key = obj.access_token;
                        token_ = key;
                        console.log(response.toString());
                        alert(response.toString());
                    }
                    else {
                        console.log(request.response.toString());
                        alert(request.response.toString());
                    }
                }
            }
            getToken(caspioTokenUrl, userName, passWord);
        }
    </script>
  </head>

  <body>

  <div id="public-api">
    <div>Public APIs</div>
    <ul>
      <li><button onclick="loadArticles(1)">All Articles</button></li>
      <li><button onclick="loadArticles(2)">All Articles with No Author</button></li>
      <li><button onclick="loadAllComments()">All Comments</button></li>
      <li>
          <label for="articleId">All Comments by Article Id</label>
          <input type="number" id="articleId" name="articleId" min="0"/>
          <button onclick="loadCommentsByArticleId()">submit</button>
      </li>
      <li>
        <div>
          <p>Login</p>
            <label for="loginEmail">Email:</label><input type="text" name="loginEmail" id="loginEmail">
            <label for="loginPassword">Password:</label><input type="password" id="loginPassword">
            <input type="submit" onclick="doLogin()">
        </div>
      </li>
    </ul>

    <hr>

    <div id="results"></div>
  </div>

  <div id="protected-api">
    <div id="p-get">
      <ul>
        <li>
          <button onclick="r_getAuthors()">All Authors</button>
        </li>
      </ul>
    </div>
  </div>
  </body>
</html>
